<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whispers on an Autumn Street</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #sketch-holder { transition: opacity 0.5s ease; }
        .fade-out { opacity: 0; }
        .fade-in { opacity: 1; }
        #pdf-link { display: none; margin-top: 10px; text-align: center; }
        #share-button { transition: background-color 0.2s; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-4xl">
        <div id="sketch-holder" class="w-full h-[600px] fade-in"></div>
        <div id="pdf-link" class="text-blue-600 hover:underline"></div>
        <div class="text-center mt-4 space-x-4">
            <button id="prev-button" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">Previous</button>
            <span id="scene-counter" class="text-lg font-semibold"></span>
            <button id="next-button" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">Next</button>
            <button id="share-button" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">Share</button>
        </div>
    </div>

    <script>
        let scenes = [
            {
                image: "images/scene1.jpg",
                dialogues: [
                    { speaker: "Sam", text: "Hey, you look deep in thought there. How are you doing?", audio: "audio/scene1_sam.mp3" }
                ]
            },
            {
                image: "images/scene2.jpg",
                dialogues: [
                    { speaker: "Lila", text: "Honestly, I'm kind of reeling. I just read something pretty amazing about how archetypes can shape—and sometimes limit—how we connect with others. I'm trying to process what it could mean.", audio: "audio/scene2_lila.mp3" },
                    { speaker: "", text: "Note: Lila is reading about archetypal theory, which explores how archetypes (like 'the hero' or 'the caregiver') can simplify human experience but may become barriers to authentic connection.", pdfLink: "./theory.pdf" }
                ]
            },
            {
                image: "images/scene3.jpg",
                dialogues: [
                    { speaker: "Sam", text: "That sounds heavy. Archetypes, like the hero or the wise old sage kind of thing?", audio: "audio/scene3_sam.mp3" },
                    { speaker: "Lila", text: "Yeah, exactly. Like, the writer, the rebel, the caregiver—those kinds of roles...", audio: "audio/scene3_lila.mp3" }
                ]
            },
            {
                image: "images/scene4.jpg",
                dialogues: [
                    { speaker: "Sam", text: "I'm a graphic designer, and sometimes I catch myself playing 'The Creative One' at work, you know?...", audio: "audio/scene4_sam.mp3" },
                    { speaker: "Lila", text: "That's exactly what they're talking about!... I'm Lila, by the way.", audio: "audio/scene4_lila.mp3" }
                ]
            },
            {
                image: "images/scene5.jpg",
                dialogues: [
                    { speaker: "Sam", text: "No, don't apologize—that's cool. I'm Sam. So, what's the big idea in this thing you read?", audio: "audio/scene5_sam.mp3" },
                    { speaker: "Lila", text: "Okay, so they talk about how we put people in boxes...", audio: "audio/scene5_lila.mp3" }
                ]
            },
            {
                image: "images/scene6.jpg",
                dialogues: [
                    { speaker: "Sam", text: "I've got a coworker who's always got an opinion, and I just write her off as 'The Bossy One'...", audio: "audio/scene6_sam.mp3" },
                    { speaker: "Lila", text: "Right? And it goes both ways. Like, I'm a teacher, and I catch myself playing 'The Patient Mentor'...", audio: "audio/scene6_lila.mp3" }
                ]
            },
            {
                image: "images/scene7.jpg",
                dialogues: [
                    { speaker: "Sam", text: "Yeah, terrifying's the word. I mean, I'm sitting here thinking, 'Don't be The Awkward Guy'...", audio: "audio/scene7_sam.mp3" },
                    { speaker: "Lila", text: "That's so real. They said in the piece—Marlon Brando, of all people—he was like...", audio: "audio/scene7_lila.mp3" }
                ]
            },
            {
                image: "images/scene8.jpg",
                dialogues: [
                    { speaker: "Sam", text: "What if I just said, 'Hey, I'm kind of lonely sometimes?'...", audio: "audio/scene8_sam.mp3" },
                    { speaker: "Lila", text: "I'm glad you did. That's not 'The Funny Guy.' That's Sam...", audio: "audio/scene8_lila.mp3" }
                ]
            },
            {
                image: "images/scene9.jpg",
                dialogues: [
                    { speaker: "Lila", text: "They said you've got to hold those archetypes lightly...", audio: "audio/scene9_lila.mp3" },
                    { speaker: "Sam", text: "A river, huh? That's kind of freeing...", audio: "audio/scene9_sam.mp3" }
                ]
            },
            {
                image: "images/scene10.jpg",
                dialogues: [
                    { speaker: "Sam", text: "Hey, um... would you maybe want to keep talking about this stuff?...", audio: "audio/scene10_sam.mp3" },
                    { speaker: "Lila", text: "I'd like that. Let's do it. No masks, no roles, just two people...", audio: "audio/scene10_lila.mp3" }
                ]
            }
        ];

        let currentScene = 0;
        let currentDialogue = 0;
        let sound; // Dialogue audio
        let backgroundMusic; // Background song
        let images = [];

        function preload() {
            // Load images and dialogue audio
            for (let i = 0; i < scenes.length; i++) {
                images[i] = loadImage(scenes[i].image, () => {}, (err) => {
                    console.error(`Failed to load image: ${scenes[i].image}`, err);
                });
                for (let dialogue of scenes[i].dialogues) {
                    if (dialogue.audio) {
                        dialogue.sound = loadSound(dialogue.audio, () => {}, (err) => {
                            console.error(`Failed to load audio: ${dialogue.audio}`, err);
                        });
                    }
                }
            }
            // Load background music
            backgroundMusic = loadSound('audio/background_music.mp3', () => {}, (err) => {
                console.error('Failed to load background music:', err);
            });
        }

        function setup() {
            try {
                let canvas = createCanvas(800, 600);
                canvas.parent('sketch-holder');
                textAlign(LEFT);
                textSize(16);
                updateSceneCounter();
                // Start background music
                if (backgroundMusic) {
                    backgroundMusic.setVolume(0.2); // Low volume to prioritize dialogues
                    backgroundMusic.loop(); // Loop continuously
                }
                displayScene();
            } catch (e) {
                console.error("Setup failed:", e);
                document.getElementById('sketch-holder').innerHTML = "<p>Error loading storybook. Please ensure all assets are available and refresh.</p>";
            }

            // Share button functionality
            document.getElementById('share-button').addEventListener('click', () => {
                const shareData = {
                    title: 'A Conversation on a City Street',
                    text: 'Explore a digital storybook about archetypes and human connection.',
                    url: 'https://ratwalster.github.io/ArchetypeEncounter/'
                };
                if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                    navigator.share(shareData).catch(err => {
                        console.error('Share failed:', err);
                    });
                } else {
                    navigator.clipboard.writeText(shareData.url).then(() => {
                        alert('Link copied to clipboard!');
                    }).catch(err => {
                        console.error('Clipboard copy failed:', err);
                        alert('Failed to copy link. Please copy manually: ' + shareData.url);
                    });
                }
            });
        }

        function updateSceneCounter() {
            document.getElementById('scene-counter').textContent = `Scene ${currentScene + 1} of ${scenes.length}`;
        }

        function playNextDialogue() {
            let scene = scenes[currentScene];
            if (currentDialogue < scene.dialogues.length && scene.dialogues[currentDialogue].sound) {
                if (sound && sound.isPlaying()) {
                    sound.stop();
                }
                sound = scene.dialogues[currentDialogue].sound;
                sound.onended(() => {
                    currentDialogue++;
                    if (currentDialogue < scene.dialogues.length && scene.dialogues[currentDialogue].sound) {
                        setTimeout(playNextDialogue, 500); // 0.5s delay between audios
                    }
                });
                sound.play();
            }
        }

        function displayScene() {
            let sketchHolder = document.getElementById('sketch-holder');
            let pdfLink = document.getElementById('pdf-link');
            let scene = scenes[currentScene];
            currentDialogue = 0; // Reset dialogue index
            sketchHolder.classList.remove('fade-in');
            sketchHolder.classList.add('fade-out');
            setTimeout(() => {
                // Draw background image
                if (images[currentScene]) {
                    image(images[currentScene], 0, 0, width, height);
                } else {
                    background(255); // Fallback if image fails
                }
                
                // Draw speech bubbles at the bottom
                let yOffset = 400; // Bottom of 600px canvas
                for (let i = 0; i < scene.dialogues.length; i++) {
                    let dialogue = scene.dialogues[i];
                    fill(255, 255, 255, 150); // Transparent for image visibility
                    stroke(200, 200, 200); // Soft gray stroke
                    strokeWeight(2);
                    rect(50, yOffset, 700, 80, 15); // Rounded corners
                    fill(0);
                    noStroke();
                    textSize(14);
                    textWrap(WORD);
                    text(dialogue.text, 60, yOffset + 20, 680);
                    yOffset += 100;
                }
                sketchHolder.classList.remove('fade-out');
                sketchHolder.classList.add('fade-in');

                // Show PDF link for Scene 2
                if (scene.dialogues.some(d => d.pdfLink)) {
                    pdfLink.style.display = 'block';
                    pdfLink.innerHTML = '<a href="./theory.pdf" target="_blank" class="text-blue-600 hover:underline">Download the archetypal theory PDF</a>';
                } else {
                    pdfLink.style.display = 'none';
                }
            }, 500);

            // Start playing dialogues
            playNextDialogue();
        }

        function nextScene() {
            if (sound && sound.isPlaying()) {
                sound.stop();
            }
            currentScene++;
            if (currentScene >= scenes.length) {
                currentScene = 0; // Loop back to start
            }
            updateSceneCounter();
            displayScene();
        }

        function prevScene() {
            if (sound && sound.isPlaying()) {
                sound.stop();
            }
            currentScene--;
            if (currentScene < 0) {
                currentScene = scenes.length - 1; // Loop to end
            }
            updateSceneCounter();
            displayScene();
        }

        // Stop music when leaving page
        window.addEventListener('unload', () => {
            if (backgroundMusic && backgroundMusic.isPlaying()) {
                backgroundMusic.stop();
            }
            if (sound && sound.isPlaying()) {
                sound.stop();
            }
        });

        document.getElementById('next-button').addEventListener('click', nextScene);
        document.getElementById('prev-button').addEventListener('click', prevScene);
    </script>
</body>
</html>
